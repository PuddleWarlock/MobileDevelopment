// ========================================
// Файл: app\src\main\java\ru\mirea\reznikap\pocketornithology\data\LoginDataSource.java
// ========================================

package ru.mirea.reznikap.pocketornithology.data;

import ru.mirea.reznikap.pocketornithology.data.model.LoggedInUser;

import java.io.IOException;

/**
 * Class that handles authentication w/ login credentials and retrieves user information.
 */
public class LoginDataSource {

    public Result<LoggedInUser> login(String username, String password) {

        try {
            // TODO: handle loggedInUser authentication
            LoggedInUser fakeUser =
                    new LoggedInUser(
                            java.util.UUID.randomUUID().toString(),
                            "Jane Doe");
            return new Result.Success<>(fakeUser);
        } catch (Exception e) {
            return new Result.Error(new IOException("Error logging in", e));
        }
    }

    public void logout() {
        // TODO: revoke authentication
    }
}

// ========================================
// Файл: app\src\main\java\ru\mirea\reznikap\pocketornithology\data\LoginRepository.java
// ========================================

package ru.mirea.reznikap.pocketornithology.data;

import ru.mirea.reznikap.pocketornithology.data.model.LoggedInUser;

/**
 * Class that requests authentication and user information from the remote data source and
 * maintains an in-memory cache of login status and user credentials information.
 */
public class LoginRepository {

    private static volatile LoginRepository instance;

    private LoginDataSource dataSource;

    // If user credentials will be cached in local storage, it is recommended it be encrypted
    // @see https://developer.android.com/training/articles/keystore
    private LoggedInUser user = null;

    // private constructor : singleton access
    private LoginRepository(LoginDataSource dataSource) {
        this.dataSource = dataSource;
    }

    public static LoginRepository getInstance(LoginDataSource dataSource) {
        if (instance == null) {
            instance = new LoginRepository(dataSource);
        }
        return instance;
    }

    public boolean isLoggedIn() {
        return user != null;
    }

    public void logout() {
        user = null;
        dataSource.logout();
    }

    private void setLoggedInUser(LoggedInUser user) {
        this.user = user;
        // If user credentials will be cached in local storage, it is recommended it be encrypted
        // @see https://developer.android.com/training/articles/keystore
    }

    public Result<LoggedInUser> login(String username, String password) {
        // handle login
        Result<LoggedInUser> result = dataSource.login(username, password);
        if (result instanceof Result.Success) {
            setLoggedInUser(((Result.Success<LoggedInUser>) result).getData());
        }
        return result;
    }
}

// ========================================
// Файл: app\src\main\java\ru\mirea\reznikap\pocketornithology\data\Result.java
// ========================================

package ru.mirea.reznikap.pocketornithology.data;

/**
 * A generic class that holds a result success w/ data or an error exception.
 */
public class Result<T> {
    // hide the private constructor to limit subclass types (Success, Error)
    private Result() {
    }

    @Override
    public String toString() {
        if (this instanceof Result.Success) {
            Result.Success success = (Result.Success) this;
            return "Success[data=" + success.getData().toString() + "]";
        } else if (this instanceof Result.Error) {
            Result.Error error = (Result.Error) this;
            return "Error[exception=" + error.getError().toString() + "]";
        }
        return "";
    }

    // Success sub-class
    public final static class Success<T> extends Result {
        private T data;

        public Success(T data) {
            this.data = data;
        }

        public T getData() {
            return this.data;
        }
    }

    // Error sub-class
    public final static class Error extends Result {
        private Exception error;

        public Error(Exception error) {
            this.error = error;
        }

        public Exception getError() {
            return this.error;
        }
    }
}

// ========================================
// Файл: app\src\main\java\ru\mirea\reznikap\pocketornithology\data\model\LoggedInUser.java
// ========================================

package ru.mirea.reznikap.pocketornithology.data.model;

/**
 * Data class that captures user information for logged in users retrieved from LoginRepository
 */
public class LoggedInUser {

    private String userId;
    private String displayName;

    public LoggedInUser(String userId, String displayName) {
        this.userId = userId;
        this.displayName = displayName;
    }

    public String getUserId() {
        return userId;
    }

    public String getDisplayName() {
        return displayName;
    }
}

// ========================================
// Файл: app\src\main\java\ru\mirea\reznikap\pocketornithology\presentation\AuthActivity.java
// ========================================

package ru.mirea.reznikap.pocketornithology.presentation;

import android.content.Intent;
import android.os.Bundle;
import android.text.TextUtils;
import android.widget.Button;
import android.widget.EditText;
import android.widget.Toast;

import androidx.annotation.Nullable;
import androidx.appcompat.app.AppCompatActivity;

import com.google.firebase.auth.FirebaseAuth;
import com.google.firebase.auth.FirebaseUser;

import ru.mirea.reznikap.data.repository.AuthRepositoryImpl;
import ru.mirea.reznikap.domain.repository.AuthRepository;
import ru.mirea.reznikap.domain.repository.RepositoryCallback;
import ru.mirea.reznikap.domain.usecase.LoginUseCase;
import ru.mirea.reznikap.domain.usecase.RegisterUseCase;
import ru.mirea.reznikap.pocketornithology.R;

public class AuthActivity extends AppCompatActivity {

    private EditText emailEditText;
    private EditText passwordEditText;
    private Button loginButton;
    private Button registerButton;

    private LoginUseCase loginUseCase;
    private RegisterUseCase registerUseCase;
    private FirebaseAuth mAuth;

    @Override
    protected void onCreate(@Nullable Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        mAuth = FirebaseAuth.getInstance();
        FirebaseUser currentUser = mAuth.getCurrentUser();
        if (currentUser != null) {
            navigateToMainScreen();
            return;
        }


        setContentView(R.layout.activity_auth);



        emailEditText = findViewById(R.id.username);
        passwordEditText = findViewById(R.id.password);
        Button loginButton = findViewById(R.id.login);
        Button registerButton = findViewById(R.id.register);


        AuthRepository authRepository = new AuthRepositoryImpl();
        loginUseCase = new LoginUseCase(authRepository);
        registerUseCase = new RegisterUseCase(authRepository);


        loginButton.setOnClickListener(v -> handleLogin());
        registerButton.setOnClickListener(v -> handleRegister());
    }

    private void handleLogin() {
        String email = emailEditText.getText().toString().trim();
        String password = passwordEditText.getText().toString().trim();

        if (!validateInput(email, password)) {
            return;
        }

        loginUseCase.execute(email, password, new RepositoryCallback<Void>() {
            @Override
            public void onSuccess(Void data) {

                Toast.makeText(AuthActivity.this, "Вход выполнен успешно", Toast.LENGTH_SHORT).show();
                navigateToMainScreen();
            }

            @Override
            public void onFailure(Exception e) {

                Toast.makeText(AuthActivity.this, "Ошибка входа: " + e.getMessage(), Toast.LENGTH_LONG).show();
            }
        });
    }

    private void handleRegister() {
        String email = emailEditText.getText().toString().trim();
        String password = passwordEditText.getText().toString().trim();

        if (!validateInput(email, password)) {
            return;
        }

        registerUseCase.execute(email, password, new RepositoryCallback<Void>() {
            @Override
            public void onSuccess(Void data) {
                Toast.makeText(AuthActivity.this, "Регистрация успешна. Выполнен вход.", Toast.LENGTH_SHORT).show();
                navigateToMainScreen();
            }

            @Override
            public void onFailure(Exception e) {
                Toast.makeText(AuthActivity.this, "Ошибка регистрации: " + e.getMessage(), Toast.LENGTH_LONG).show();
            }
        });
    }

    private boolean validateInput(String email, String password) {
        if (TextUtils.isEmpty(email)) {
            emailEditText.setError("Введите email");
            return false;
        }
        if (TextUtils.isEmpty(password)) {
            passwordEditText.setError("Введите пароль");
            return false;
        }
        if (password.length() < 6) {
            passwordEditText.setError("Пароль должен быть не менее 6 символов");
            return false;
        }
        return true;
    }

    private void navigateToMainScreen() {
        Intent intent = new Intent(AuthActivity.this, MainActivity.class);
        startActivity(intent);
        finish();
    }

}

// ========================================
// Файл: app\src\main\java\ru\mirea\reznikap\pocketornithology\presentation\MainActivity.java
// ========================================

package ru.mirea.reznikap.pocketornithology.presentation;

import androidx.annotation.Nullable;
import androidx.appcompat.app.AppCompatActivity;
import androidx.lifecycle.ViewModelProvider;

import android.content.Intent;
import android.graphics.Bitmap;
import android.os.Bundle;
import android.provider.MediaStore;
import android.widget.Button;
import android.widget.TextView;
import android.widget.Toast;

import java.io.ByteArrayOutputStream;

import ru.mirea.reznikap.data.repository.AuthRepositoryImpl;
import ru.mirea.reznikap.data.storage.AppDatabase;
import ru.mirea.reznikap.domain.models.BirdInfo;
import ru.mirea.reznikap.domain.repository.RepositoryCallback;
import ru.mirea.reznikap.domain.usecase.GetBirdInfoUseCase;
import ru.mirea.reznikap.domain.usecase.LogoutUseCase;
import ru.mirea.reznikap.pocketornithology.R;
import ru.mirea.reznikap.data.repository.OrnithologyRepositoryImpl;
import ru.mirea.reznikap.domain.repository.OrnithologyRepository;
import ru.mirea.reznikap.domain.usecase.RecognizeBirdUseCase;
import ru.mirea.reznikap.pocketornithology.presentation.factories.ViewModelFactory;
import ru.mirea.reznikap.pocketornithology.presentation.viewmodels.RecognitionViewModel;

public class MainActivity extends AppCompatActivity {

    private static final int REQUEST_IMAGE_CAPTURE = 1;
    private TextView resultTextView;
    /*private RecognizeBirdUseCase recognizeBirdUseCase;
    private GetBirdInfoUseCase getBirdInfoUseCase;
    private LogoutUseCase logoutUseCase;*/

    private RecognitionViewModel viewModel;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        ViewModelFactory viewModelFactory = new ViewModelFactory(getApplicationContext());
        viewModel = new ViewModelProvider(this, viewModelFactory).get(RecognitionViewModel.class);

        resultTextView = findViewById(R.id.resultTextView);
        Button recognizeBtn = findViewById(R.id.buttonRecognize);
        Button logoutButton = findViewById(R.id.buttonLogout);

        AppDatabase db = AppDatabase.getDatabase(getApplicationContext());
        AuthRepositoryImpl authRepository = new AuthRepositoryImpl();
        OrnithologyRepository repository = new OrnithologyRepositoryImpl(db.observationDao());
        /*recognizeBirdUseCase = new RecognizeBirdUseCase(repository);
        getBirdInfoUseCase = new GetBirdInfoUseCase(repository);
        logoutUseCase = new LogoutUseCase(authRepository);*/

        setupObservers();

        recognizeBtn.setOnClickListener(v -> dispatchTakePictureIntent());
        logoutButton.setOnClickListener(v -> handleLogout());
    }

    private void setupObservers() {


        viewModel.getBirdInfo().observe(this, birdInfo -> {
            resultTextView.setText(birdInfo.name + "\n\n" + birdInfo.description);
        });


        viewModel.getError().observe(this, errorMessage -> {
            Toast.makeText(this, errorMessage, Toast.LENGTH_LONG).show();
            resultTextView.setText("Произошла ошибка");
        });
    }

    private void dispatchTakePictureIntent() {
        Intent takePictureIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);
        if (takePictureIntent.resolveActivity(getPackageManager()) != null) {
            startActivityForResult(takePictureIntent, REQUEST_IMAGE_CAPTURE);
        }
    }

    @Override
    protected void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {
        super.onActivityResult(requestCode, resultCode, data);
        if (requestCode == REQUEST_IMAGE_CAPTURE && resultCode == RESULT_OK && data != null) {
            Bundle extras = data.getExtras();
            Bitmap imageBitmap = (Bitmap) extras.get("data");

            ByteArrayOutputStream stream = new ByteArrayOutputStream();
            imageBitmap.compress(Bitmap.CompressFormat.JPEG, 100, stream);
            byte[] byteArray = stream.toByteArray();

            /*recognizeAndGetInfo(byteArray);*/
            viewModel.startRecognition(byteArray);
        }
    }

    private void recognizeAndGetInfo(byte[] imageBytes) {
        resultTextView.setText("Распознавание...");
        recognizeBirdUseCase.execute(imageBytes, new RepositoryCallback<String>() {
            @Override
            public void onSuccess(String birdName) {
                resultTextView.setText("Распознано: " + birdName + "\nЗагрузка информации...");
                fetchBirdInfo(birdName);
            }
            @Override
            public void onFailure(Exception e) {
                resultTextView.setText("Ошибка распознавания: " + e.getMessage());
            }
        });
    }

    private void fetchBirdInfo(String birdName) {
        getBirdInfoUseCase.execute(birdName, new RepositoryCallback<BirdInfo>() {
            @Override
            public void onSuccess(BirdInfo info) {
                resultTextView.setText(info.name + "\n\n" + info.description);
            }
            @Override
            public void onFailure(Exception e) {
                Toast.makeText(MainActivity.this, "Ошибка загрузки данных: " + e.getMessage(), Toast.LENGTH_LONG).show();
            }
        });
    }

    private void handleLogout() {
        logoutUseCase.execute();

        Toast.makeText(this, "Вы вышли из аккаунта", Toast.LENGTH_SHORT).show();

        Intent intent = new Intent(MainActivity.this, AuthActivity.class);

        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);
        startActivity(intent);

        finish();
    }
}

// ========================================
// Файл: app\src\main\java\ru\mirea\reznikap\pocketornithology\presentation\factories\ViewModelFactory.java
// ========================================

package ru.mirea.reznikap.pocketornithology.presentation.factories;

import android.content.Context;

import androidx.annotation.NonNull;
import androidx.lifecycle.ViewModel;
import androidx.lifecycle.ViewModelProvider;

import ru.mirea.reznikap.data.repository.OrnithologyRepositoryImpl;
import ru.mirea.reznikap.data.storage.AppDatabase;
import ru.mirea.reznikap.domain.repository.OrnithologyRepository;
import ru.mirea.reznikap.pocketornithology.presentation.viewmodels.RecognitionViewModel;

public class ViewModelFactory implements ViewModelProvider.Factory {

    private final OrnithologyRepository ornithologyRepository;

    public ViewModelFactory(Context context) {
        AppDatabase db = AppDatabase.getDatabase(context.getApplicationContext());
        this.ornithologyRepository = new OrnithologyRepositoryImpl(db.observationDao());
    }

    @NonNull
    @Override
    public <T extends ViewModel> T create(@NonNull Class<T> modelClass) {
        if (modelClass.isAssignableFrom(RecognitionViewModel.class)) {
            return (T) new RecognitionViewModel(ornithologyRepository);
        }
        throw new IllegalArgumentException("Unknown ViewModel class");
    }
}


// ========================================
// Файл: app\src\main\java\ru\mirea\reznikap\pocketornithology\presentation\viewmodels\ObservationDetailsViewModel.java
// ========================================

package ru.mirea.reznikap.pocketornithology.presentation.viewmodels;

import androidx.lifecycle.LiveData;
import androidx.lifecycle.MediatorLiveData;
import androidx.lifecycle.MutableLiveData;
import androidx.lifecycle.ViewModel;

import ru.mirea.reznikap.domain.models.BirdInfo;
import ru.mirea.reznikap.domain.models.Observation;
import ru.mirea.reznikap.domain.repository.OrnithologyRepository;
import ru.mirea.reznikap.domain.repository.RepositoryCallback;
import ru.mirea.reznikap.domain.usecase.GetBirdInfoUseCase;

public class ObservationDetailsViewModel extends ViewModel {

    private final GetObservationByIdUseCase getObservationByIdUseCase; // Получает данные из Room
    private final GetBirdInfoUseCase getBirdInfoUseCase;         // Получает данные из сети

    // Источники данных
    private LiveData<Observation> observationFromDb;
    private LiveData<BirdInfo> freshInfoFromApi;

    // Финальный объект, на который подписывается Activity
    private final MediatorLiveData<Observation> combinedDetails = new MediatorLiveData<>();

    public ObservationDetailsViewModel(OrnithologyRepository repository, int observationId) {
        this.getObservationByIdUseCase = new GetObservationByIdUseCase(repository); // Предполагаем, что такой UseCase есть
        this.getBirdInfoUseCase = new GetBirdInfoUseCase(repository);

        // Запускаем загрузку из обоих источников
        loadObservationDetails(observationId);
    }

    public LiveData<Observation> getCombinedDetails() {
        return combinedDetails;
    }

    private void loadObservationDetails(int observationId) {
        // Получаем LiveData из репозитория (предполагаем, что DAO возвращает LiveData)
        observationFromDb = getObservationByIdUseCase.execute(observationId);

        combinedDetails.addSource(observationFromDb, observation -> {
            // Как только данные из БД пришли, обновляем наш финальный LiveData
            combinedDetails.setValue(observation);
            // И сразу же запрашиваем свежие данные из сети
            if (observation != null) {
                fetchFreshInfo(observation.birdName);
            }
        });
    }

    private void fetchFreshInfo(String birdName) {
        // Здесь мы бы использовали асинхронный вызов, который возвращает LiveData
        // Для примера, используем наш существующий колбэк
        MutableLiveData<BirdInfo> networkResult = new MutableLiveData<>();
        freshInfoFromApi = networkResult;

        getBirdInfoUseCase.execute(birdName, new RepositoryCallback<BirdInfo>() {
            @Override
            public void onSuccess(BirdInfo freshInfo) {
                networkResult.setValue(freshInfo);
            }
            @Override public void onFailure(Exception e) { /* ... */ }
        });

        combinedDetails.addSource(freshInfoFromApi, freshInfo -> {
            // Когда пришли свежие данные из сети, снова обновляем финальный LiveData
            Observation currentObservation = combinedDetails.getValue();
            if (currentObservation != null && freshInfo != null) {
                // Обновляем описание в нашем объекте
                // Observation - это final класс, так что создаем новый
                Observation updatedObservation = new Observation(
                        currentObservation.id,
                        currentObservation.birdName,
                        freshInfo.description, // Обновленное описание
                        currentObservation.photoPath,
                        currentObservation.timestamp
                );
                combinedDetails.setValue(updatedObservation);
            }
        });
    }
}


// ========================================
// Файл: app\src\main\java\ru\mirea\reznikap\pocketornithology\presentation\viewmodels\RecognitionViewModel.java
// ========================================

package ru.mirea.reznikap.pocketornithology.presentation.viewmodels;

import androidx.lifecycle.LiveData;
import androidx.lifecycle.MutableLiveData;
import androidx.lifecycle.ViewModel;

import ru.mirea.reznikap.domain.models.BirdInfo;
import ru.mirea.reznikap.domain.repository.OrnithologyRepository;
import ru.mirea.reznikap.domain.repository.RepositoryCallback;
import ru.mirea.reznikap.domain.usecase.GetBirdInfoUseCase;
import ru.mirea.reznikap.domain.usecase.RecognizeBirdUseCase;
import ru.mirea.reznikap.domain.usecase.SaveObservationUseCase;

public class RecognitionViewModel extends ViewModel {

    private final RecognizeBirdUseCase recognizeBirdUseCase;
    private final GetBirdInfoUseCase getBirdInfoUseCase;
    private final SaveObservationUseCase saveObservationUseCase;

    private final MutableLiveData<String> recognitionResult = new MutableLiveData<>();
    private final MutableLiveData<BirdInfo> birdInfo = new MutableLiveData<>();
    private final MutableLiveData<Boolean> isLoading = new MutableLiveData<>();
    private final MutableLiveData<String> error = new MutableLiveData<>();


    public LiveData<String> getRecognitionResult() { return recognitionResult; }
    public LiveData<BirdInfo> getBirdInfo() { return birdInfo; }
    public LiveData<Boolean> getIsLoading() { return isLoading; }
    public LiveData<String> getError() { return error; }

    public RecognitionViewModel(OrnithologyRepository repository) {
        this.recognizeBirdUseCase = new RecognizeBirdUseCase(repository);
        this.getBirdInfoUseCase = new GetBirdInfoUseCase(repository);
        this.saveObservationUseCase = new SaveObservationUseCase(repository);
    }

    public void startRecognition(byte[] imageBytes) {
        isLoading.setValue(true);
        recognizeBirdUseCase.execute(imageBytes, new RepositoryCallback<String>() {
            @Override
            public void onSuccess(String birdName) {
                recognitionResult.setValue(birdName);
                fetchBirdInfo(birdName);
            }
            @Override
            public void onFailure(Exception e) {
                error.setValue("Ошибка распознавания: " + e.getMessage());
                isLoading.setValue(false);
            }
        });
    }

    private void fetchBirdInfo(String birdName) {
        getBirdInfoUseCase.execute(birdName, new RepositoryCallback<BirdInfo>() {
            @Override
            public void onSuccess(BirdInfo info) {
                birdInfo.setValue(info);
                isLoading.setValue(false);
            }
            @Override
            public void onFailure(Exception e) {
                error.setValue("Ошибка загрузки данных: " + e.getMessage());
                isLoading.setValue(false);
            }
        });
    }

}

// ========================================
// Файл: data\src\main\java\ru\mirea\reznikap\data\mappers\ObservationMapper.java
// ========================================

package ru.mirea.reznikap.data.mappers;

import ru.mirea.reznikap.data.models.ObservationData;
import ru.mirea.reznikap.domain.models.Observation;

public class ObservationMapper {

    public Observation mapToDomain(ObservationData data) {
        return new Observation(data.id, data.birdName, data.photoPath, data.timestamp);
    }


    public ObservationData mapToData(Observation domain) {
        ObservationData data = new ObservationData();
        data.id = domain.id;
        data.birdName = domain.birdName;
        data.photoPath = domain.photoPath;
        data.timestamp = domain.timestamp;
        return data;
    }
}


// ========================================
// Файл: data\src\main\java\ru\mirea\reznikap\data\models\ObservationData.java
// ========================================

package ru.mirea.reznikap.data.models;

import androidx.room.Entity;
import androidx.room.PrimaryKey;

@Entity(tableName = "observations")
public class ObservationData {
    @PrimaryKey(autoGenerate = true)
    public int id;
    public String birdName;
    public String photoPath;
    public long timestamp;
}

// ========================================
// Файл: data\src\main\java\ru\mirea\reznikap\data\network\ApiClient.java
// ========================================

package ru.mirea.reznikap.data.network;

import retrofit2.Retrofit;
import retrofit2.converter.gson.GsonConverterFactory;


public class ApiClient {

    private static final String BASE_URL = "https://ru.wikipedia.org/w/";
    private static Retrofit retrofit = null;

    public static Retrofit getClient() {
        if (retrofit == null) {
            retrofit = new Retrofit.Builder()
                    .baseUrl(BASE_URL)
                    .addConverterFactory(GsonConverterFactory.create())
                    .build();
        }
        return retrofit;
    }
}


// ========================================
// Файл: data\src\main\java\ru\mirea\reznikap\data\network\WikipediaApi.java
// ========================================

package ru.mirea.reznikap.data.network;

import com.google.gson.annotations.SerializedName;

import java.util.Map;

import retrofit2.Call;
import retrofit2.http.GET;
import retrofit2.http.Query;

public interface WikipediaApi {

    @GET("api.php?action=query&prop=extracts&exintro&explaintext&format=json")
    Call<WikipediaDto> getBirdExtract(@Query("titles") String birdName);
}


// ========================================
// Файл: data\src\main\java\ru\mirea\reznikap\data\network\WikipediaDto.java
// ========================================

package ru.mirea.reznikap.data.network;

import com.google.gson.annotations.SerializedName;

import java.util.Map;

public class WikipediaDto {
    @SerializedName("query")
    public Query query;

    public static class Query {
        @SerializedName("pages")
        public Map<String, Page> pages;
    }

    public static class Page {
        @SerializedName("title")
        public String title;
        @SerializedName("extract")
        public String extract;
    }
}


// ========================================
// Файл: data\src\main\java\ru\mirea\reznikap\data\repository\AuthRepositoryImpl.java
// ========================================

package ru.mirea.reznikap.data.repository;

import com.google.firebase.auth.FirebaseAuth;

import ru.mirea.reznikap.domain.repository.AuthRepository;
import ru.mirea.reznikap.domain.repository.RepositoryCallback;

public class AuthRepositoryImpl implements AuthRepository {
    private final FirebaseAuth mAuth;
    public AuthRepositoryImpl() {
        mAuth = FirebaseAuth.getInstance();
    }
    @Override
    public void login(String email, String password, RepositoryCallback<Void> callback) {
        mAuth.signInWithEmailAndPassword(email, password)
                .addOnSuccessListener(authResult -> callback.onSuccess(null))
                .addOnFailureListener(callback::onFailure);
    }
    @Override
    public void register(String email, String password, RepositoryCallback<Void> callback) {
        mAuth.createUserWithEmailAndPassword(email, password)
                .addOnSuccessListener(authResult -> callback.onSuccess(null))
                .addOnFailureListener(callback::onFailure);
    }
    @Override
    public void logout() {
        mAuth.signOut();
    }
}


// ========================================
// Файл: data\src\main\java\ru\mirea\reznikap\data\repository\OrnithologyRepositoryImpl.java
// ========================================

package ru.mirea.reznikap.data.repository;

import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.os.Handler;
import android.os.Looper;

import androidx.annotation.NonNull;

import retrofit2.Call;
import retrofit2.Callback;
import retrofit2.Response;
import ru.mirea.reznikap.data.mappers.ObservationMapper;
import ru.mirea.reznikap.data.network.ApiClient;
import ru.mirea.reznikap.data.network.WikipediaApi;
import ru.mirea.reznikap.data.network.WikipediaDto;
import ru.mirea.reznikap.data.storage.ObservationDao;
import ru.mirea.reznikap.domain.models.BirdInfo;
import ru.mirea.reznikap.domain.models.Observation;
import ru.mirea.reznikap.domain.repository.OrnithologyRepository;
import ru.mirea.reznikap.domain.repository.RepositoryCallback;

import java.util.List;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.stream.Collectors;

public class OrnithologyRepositoryImpl implements OrnithologyRepository {

    private final ObservationDao observationDao;
    private final WikipediaApi wikipediaApi;
    private final ObservationMapper mapper = new ObservationMapper();
    private final ExecutorService executor = Executors.newSingleThreadExecutor();
    private final Handler mainThreadHandler = new Handler(Looper.getMainLooper());

    public OrnithologyRepositoryImpl(ObservationDao dao) {
        this.observationDao = dao;
        this.wikipediaApi = ApiClient.getClient().create(WikipediaApi.class);
    }

    @Override
    public void recognizeBird(byte[] imageBytes, RepositoryCallback<String> callback) {
        executor.execute(() -> {
            try {
                Bitmap bitmap = BitmapFactory.decodeByteArray(imageBytes, 0, imageBytes.length);
                String result = "Синица большая (тест)";
                mainThreadHandler.post(() -> callback.onSuccess(result));
            } catch (Exception e) {
                mainThreadHandler.post(() -> callback.onFailure(e));
            }
        });
    }

    @Override
    public void getBirdInfo(String birdName, RepositoryCallback<BirdInfo> callback) {
        wikipediaApi.getBirdExtract(birdName).enqueue(new Callback<WikipediaDto>() {
            @Override
            public void onResponse(@NonNull Call<WikipediaDto> call, @NonNull Response<WikipediaDto> response) {
                if (response.isSuccessful() && response.body() != null) {
                    WikipediaDto.Page page = response.body().query.pages.values().iterator().next();
                    BirdInfo info = new BirdInfo(page.title, page.extract, "");
                    callback.onSuccess(info);
                } else {
                    callback.onFailure(new Exception("API Error: " + response.code()));
                }
            }
            @Override
            public void onFailure(@NonNull Call<WikipediaDto> call, @NonNull Throwable t) {
                callback.onFailure(new Exception(t));
            }
        });
    }

    @Override
    public void saveObservation(Observation observation, RepositoryCallback<Void> callback) {
        executor.execute(() -> {
            try {
                observationDao.insert(mapper.mapToData(observation));
                mainThreadHandler.post(() -> callback.onSuccess(null));
            } catch (Exception e) {
                mainThreadHandler.post(() -> callback.onFailure(e));
            }
        });
    }

    @Override
    public void getJournal(RepositoryCallback<List<Observation>> callback) {
        executor.execute(() -> {
            try {
                List<Observation> journal = observationDao.getAll().stream()
                        .map(mapper::mapToDomain)
                        .collect(Collectors.toList());
                mainThreadHandler.post(() -> callback.onSuccess(journal));
            } catch (Exception e) {
                mainThreadHandler.post(() -> callback.onFailure(e));
            }
        });
    }
}

// ========================================
// Файл: data\src\main\java\ru\mirea\reznikap\data\storage\AppDatabase.java
// ========================================

package ru.mirea.reznikap.data.storage;

import android.content.Context;

import androidx.room.Database;
import androidx.room.Room;
import androidx.room.RoomDatabase;

import ru.mirea.reznikap.data.models.ObservationData;

@Database(entities = {ObservationData.class}, version = 1)
public abstract class AppDatabase extends RoomDatabase {
    public abstract ObservationDao observationDao();

    private static volatile AppDatabase INSTANCE;

    public static AppDatabase getDatabase(final Context context) {
        if (INSTANCE == null) {
            synchronized (AppDatabase.class) {
                if (INSTANCE == null) {
                    INSTANCE = Room.databaseBuilder(context.getApplicationContext(),
                                    AppDatabase.class, "ornithology_database")
                            .build();
                }
            }
        }
        return INSTANCE;
    }
}


// ========================================
// Файл: data\src\main\java\ru\mirea\reznikap\data\storage\ObservationDao.java
// ========================================

package ru.mirea.reznikap.data.storage;

import androidx.room.Dao;
import androidx.room.Insert;
import androidx.room.OnConflictStrategy;
import androidx.room.Query;

import java.util.List;

import ru.mirea.reznikap.data.models.ObservationData;

@Dao
public interface ObservationDao {
    @Query("SELECT * FROM observations ORDER BY timestamp DESC")
    List<ObservationData> getAll();

    @Insert(onConflict = OnConflictStrategy.REPLACE)
    void insert(ObservationData observation);
}


// ========================================
// Файл: data\src\main\java\ru\mirea\reznikap\data\storage\UserPrefsStorage.java
// ========================================

package ru.mirea.reznikap.data.storage;

import android.content.Context;
import android.content.SharedPreferences;

public class UserPrefsStorage {
    private static final String PREFS_NAME = "user_prefs";
    private static final String KEY_USER_NAME = "user_name";
    private final SharedPreferences sharedPreferences;

    public UserPrefsStorage(Context context) {
        sharedPreferences = context.getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE);
    }

    public void saveUserName(String name) {
        sharedPreferences.edit().putString(KEY_USER_NAME, name).apply();
    }

    public String getUserName() {
        return sharedPreferences.getString(KEY_USER_NAME, "Default User");
    }
}


// ========================================
// Файл: domain\src\main\java\ru\mirea\reznikap\domain\MyClass.java
// ========================================

package ru.mirea.reznikap.domain;

public class MyClass {
}

// ========================================
// Файл: domain\src\main\java\ru\mirea\reznikap\domain\models\BirdInfo.java
// ========================================

package ru.mirea.reznikap.domain.models;

public class BirdInfo {
    public final String name;
    public final String description;
    public final String imageUrl;

    public BirdInfo(String name, String description, String imageUrl) {
        this.name = name;
        this.description = description;
        this.imageUrl = imageUrl;
    }
}

// ========================================
// Файл: domain\src\main\java\ru\mirea\reznikap\domain\models\Observation.java
// ========================================

package ru.mirea.reznikap.domain.models;

public class Observation {
    public final int id;
    public final String birdName;
    public final String photoPath;
    public final long timestamp;

    public Observation(int id, String birdName, String photoPath, long timestamp) {
        this.id = id;
        this.birdName = birdName;
        this.photoPath = photoPath;
        this.timestamp = timestamp;
    }
}

// ========================================
// Файл: domain\src\main\java\ru\mirea\reznikap\domain\repository\AuthRepository.java
// ========================================

package ru.mirea.reznikap.domain.repository;

public interface AuthRepository {
    void login(String email, String password, RepositoryCallback<Void> callback);
    void register(String email, String password, RepositoryCallback<Void> callback);
    void logout();
}


// ========================================
// Файл: domain\src\main\java\ru\mirea\reznikap\domain\repository\OrnithologyRepository.java
// ========================================

package ru.mirea.reznikap.domain.repository;

import ru.mirea.reznikap.domain.models.BirdInfo;
import ru.mirea.reznikap.domain.models.Observation;
import java.util.List;

public interface OrnithologyRepository {
    void recognizeBird(byte[] imageBytes, RepositoryCallback<String> callback);
    void getBirdInfo(String birdName, RepositoryCallback<BirdInfo> callback);
    void saveObservation(Observation observation, RepositoryCallback<Void> callback);
    void getJournal(RepositoryCallback<List<Observation>> callback);
}

// ========================================
// Файл: domain\src\main\java\ru\mirea\reznikap\domain\repository\RepositoryCallback.java
// ========================================

package ru.mirea.reznikap.domain.repository;

public interface RepositoryCallback<T> {
    void onSuccess(T data);
    void onFailure(Exception e);
}


// ========================================
// Файл: domain\src\main\java\ru\mirea\reznikap\domain\usecase\GetBirdInfoUseCase.java
// ========================================

package ru.mirea.reznikap.domain.usecase;

import ru.mirea.reznikap.domain.models.BirdInfo;
import ru.mirea.reznikap.domain.repository.OrnithologyRepository;
import ru.mirea.reznikap.domain.repository.RepositoryCallback;

public class GetBirdInfoUseCase {
    private final OrnithologyRepository repository;

    public GetBirdInfoUseCase(OrnithologyRepository repository) {
        this.repository = repository;
    }

    public void execute(String birdName, RepositoryCallback<BirdInfo> callback) {
        repository.getBirdInfo(birdName, callback);
    }
}

// ========================================
// Файл: domain\src\main\java\ru\mirea\reznikap\domain\usecase\GetJournalUseCase.java
// ========================================

package ru.mirea.reznikap.domain.usecase;

import java.util.List;

import ru.mirea.reznikap.domain.models.Observation;
import ru.mirea.reznikap.domain.repository.OrnithologyRepository;
import ru.mirea.reznikap.domain.repository.RepositoryCallback;


public class GetJournalUseCase {
    private final OrnithologyRepository repository;

    public GetJournalUseCase(OrnithologyRepository repository) {
        this.repository = repository;
    }

    public void execute(RepositoryCallback<List<Observation>> callback) {
        repository.getJournal(callback);
    }
}

// ========================================
// Файл: domain\src\main\java\ru\mirea\reznikap\domain\usecase\LoginUseCase.java
// ========================================

package ru.mirea.reznikap.domain.usecase;

import ru.mirea.reznikap.domain.repository.AuthRepository;
import ru.mirea.reznikap.domain.repository.RepositoryCallback;

public class LoginUseCase {
    private final AuthRepository repository;
    public LoginUseCase(AuthRepository repository) { this.repository = repository; }
    public void execute(String email, String password, RepositoryCallback<Void> callback) {
        repository.login(email, password, callback);
    }
}


// ========================================
// Файл: domain\src\main\java\ru\mirea\reznikap\domain\usecase\LogoutUseCase.java
// ========================================

package ru.mirea.reznikap.domain.usecase;

import ru.mirea.reznikap.domain.repository.AuthRepository;

public class LogoutUseCase {
    private final AuthRepository repository;

    public LogoutUseCase(AuthRepository repository) {
        this.repository = repository;
    }

    public void execute() {
        repository.logout();
    }
}


// ========================================
// Файл: domain\src\main\java\ru\mirea\reznikap\domain\usecase\RecognizeBirdUseCase.java
// ========================================

package ru.mirea.reznikap.domain.usecase;


import ru.mirea.reznikap.domain.repository.OrnithologyRepository;
import ru.mirea.reznikap.domain.repository.RepositoryCallback;

public class RecognizeBirdUseCase {
    private final OrnithologyRepository repository;

    public RecognizeBirdUseCase(OrnithologyRepository repository) {
        this.repository = repository;
    }

    public void execute(byte[] imageBytes, RepositoryCallback<String> callback) {
        repository.recognizeBird(imageBytes, callback);
    }
}

// ========================================
// Файл: domain\src\main\java\ru\mirea\reznikap\domain\usecase\RegisterUseCase.java
// ========================================

package ru.mirea.reznikap.domain.usecase;

import ru.mirea.reznikap.domain.repository.AuthRepository;
import ru.mirea.reznikap.domain.repository.RepositoryCallback;


public class RegisterUseCase {
    private final AuthRepository repository;

    public RegisterUseCase(AuthRepository repository) {
        this.repository = repository;
    }

    public void execute(String email, String password, RepositoryCallback<Void> callback) {
        repository.register(email, password, callback);
    }
}


// ========================================
// Файл: domain\src\main\java\ru\mirea\reznikap\domain\usecase\SaveObservationUseCase.java
// ========================================

package ru.mirea.reznikap.domain.usecase;

import ru.mirea.reznikap.domain.models.Observation;
import ru.mirea.reznikap.domain.repository.OrnithologyRepository;
import ru.mirea.reznikap.domain.repository.RepositoryCallback;


public class SaveObservationUseCase {
    private final OrnithologyRepository repository;

    public SaveObservationUseCase(OrnithologyRepository repository) {
        this.repository = repository;
    }

    public void execute(Observation observation, RepositoryCallback<Void> callback) {
        repository.saveObservation(observation, callback);
    }
}

